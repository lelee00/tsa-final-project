---
title: "Initial Analysis"
author: "LE Lee"
date: "3/30/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(fable)
library(tidyr)
library(lubridate)
library(tsibble)
library(stringr)
library(feasts)
library(imputeTS)
```

```{r}
county_zips <- read.csv('county-zips.csv', header = T) %>% rename(zip = Zip) %>% mutate(zip = as.character(zip))
historical <- read.csv('historical_initial.csv', header = T)
info <- read.csv('info_initial.csv', header = T)
```

```{r}
h <- historical %>%
  separate(address, sep = ', ', into = c("street","city","statezip")) %>%
  separate(statezip, sep = ' ', into = c('state','zip')) %>%
  separate(Price, sep = " ", into = c("price", NA))
i <- info %>% separate(address, sep = ', ', into = c("street","city","statezip")) %>% separate(statezip, sep = ' ', into = c('state','zip'))
```
```{r}
i <- i %>% filter(beds > 0 & baths > 0) %>% select(link:sqft & !'list_price')
h <- h %>% select(street:price)
```


```{r}
sold <- h %>% filter(Event == "Sold")
list <- h %>% filter(Event == "Listed for sale")
change <- historical %>% filter(Event == "Price change") %>% separate(Price, sep = " ", into = c("to","pct"))
```

```{r}
sold_info <- sold %>%
  left_join(i, by = c("street","city","state","zip"))
si <- sold_info %>%
  filter(complete.cases(sold_info)) %>%
  left_join(county_zips, by = 'zip') %>%
  relocate(Date, .before = street) %>%
  relocate(County, .before = street) %>%
  mutate(Date = yearmonth(mdy(Date)), price = as.numeric(str_replace_all(price, "[[$,]]",""))) 
```



```{r}
si %>% filter(complete.cases(si)) %>%
  group_by(Date, County) %>%
  summarise(mean_sale = mean(price)) %>%
  as_tsibble(index = Date, key = County) %>%
  autoplot() + xlab("Date of Sale") + ylab("Mean Sale Price") + ggtitle("Monthly Mean Sale Price, All Homes, By County")
si %>% filter(complete.cases(si)) %>%
  group_by(Date) %>%
  summarise(mean_sale = mean(price)) %>%
  as_tsibble(index = Date) %>%
  autoplot() + xlab("Date of Sale") + ylab("Mean Sale Price") + ggtitle("Monthly Mean Sale Price, All Homes")
si %>% filter(complete.cases(si)) %>%
  mutate(Date = yearquarter(Date)) %>%
  group_by(Date) %>%
  summarise(mean_sale = mean(price)) %>%
  as_tsibble(index = Date) %>%
  autoplot() + xlab("Date of Sale") + ylab("Mean Sale Price") + ggtitle("Quarterly Mean Sale Price, All Homes")
```



```{r}
si %>% group_by(Date, County) %>% summarise(total_sales = sum(price), count_sales = n()) %>% as_tsibble(index = Date, key = County) %>% autoplot()

si %>% filter(complete.cases(si)) %>% mutate(Date = year(Date)) %>% group_by(Date) %>% summarise(total_sales = sum(price), count_sales = n()) %>% as_tsibble(index = Date) %>% fill_gaps() %>% model(stl = STL(total_sales)) %>% components() %>% autoplot()

si %>% filter(complete.cases(si)) %>% mutate(Date = year(Date)) %>% group_by(Date) %>% summarise(total_sales = sum(price), count_sales = n()) %>% as_tsibble(index = Date) %>% fill_gaps() %>% model(stl = STL(count_sales)) %>% components() %>% autoplot()

si %>% filter(complete.cases(si)) %>% group_by(Date) %>% summarise(count_sales = n()) %>% as_tsibble(index = Date) %>% fill_gaps(count_sales = 0) %>% model(classical_decomposition(count_sales, type = "additive")) %>% components() %>% autoplot()

si %>% filter(complete.cases(si)) %>% group_by(Date) %>% summarise(mean_sale = mean(price)) %>% as_tsibble(index = Date) %>% fill_gaps(mean_sale = 0) %>% model(classical_decomposition(mean_sale, type = "additive")) %>% components() %>% autoplot()

si %>% filter(complete.cases(si)) %>% group_by(Date) %>% summarise(count_sales = n()) %>% as_tsibble(index = Date) %>% fill_gaps(count_sales = 0) %>% model(classical_decomposition(count_sales, type = "multiplicative")) %>% components() %>% autoplot()

si %>% filter(complete.cases(si)) %>% group_by(Date) %>% summarise(mean_sale = mean(price)) %>% as_tsibble(index = Date) %>% fill_gaps(mean_sale = 0) %>% model(classical_decomposition(mean_sale, type = "multiplicative")) %>% components() %>% autoplot()

```

